;!function(){try { var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&((e._debugIds|| (e._debugIds={}))[n]="72dad8fc-412d-0572-4aa0-1c1578cbd972")}catch(e){}}();
(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,166926,e=>{"use strict";var t=e.i(478902),n=e.i(202584),s=e.i(215261),a=e.i(898452),i=e.i(389959),r=e.i(158639),l=e.i(356003),o=e.i(283342),c=e.i(774803),d=e.i(914417),u=e.i(355901);e.i(128328);var m=e.i(86086),h=e.i(947748),p=e.i(215618),g=e.i(915083),x=e.i(805303),f=e.i(300475),y=e.i(242882),S=e.i(714403),b=e.i(440673),j=e.i(246230);async function w({projectRef:e,connectionString:t,schemas:n,limit:s},a){let i=(({schemas:e,limit:t=100})=>`
${b.CREATE_PG_GET_TABLEDEF_SQL}

with records as (
  select
    c.oid::int8 as "id",
    case c.relkind
      when 'r' then pg_temp.pg_get_tabledef(
        concat(nc.nspname),
        concat(c.relname),
        false,
        'FKEYS_INTERNAL',
        'NO_TRIGGERS'
      )
      when 'v' then concat(
        'create view ', concat(nc.nspname, '.', c.relname), ' as',
        pg_get_viewdef(concat(nc.nspname, '.', c.relname), true)
      )
      when 'm' then concat(
        'create materialized view ', concat(nc.nspname, '.', c.relname), ' as',
        pg_get_viewdef(concat(nc.nspname, '.', c.relname), true)
      )
      when 'f' then concat('create foreign table ', nc.nspname, '.', c.relname, ' ( ... )')
      when 'p' then pg_temp.pg_get_tabledef(
        concat(nc.nspname),
        concat(c.relname),
        false,
        'FKEYS_INTERNAL',
        'NO_TRIGGERS'
      )
    end as "sql"
  from
    pg_namespace nc
    join pg_class c on nc.oid = c.relnamespace
  where
    c.relkind in ('r', 'v', 'm', 'f', 'p')
    and not pg_is_other_temp_schema(nc.oid)
    and (
      pg_has_role(c.relowner, 'USAGE')
      or has_table_privilege(
        c.oid,
        'SELECT, INSERT, UPDATE, DELETE, TRUNCATE, REFERENCES, TRIGGER'
      )
      or has_any_column_privilege(c.oid, 'SELECT, INSERT, UPDATE, REFERENCES')
    )
    and nc.nspname IN (${e.map(e=>`'${e}'`).join(", ")})
  order by c.relname asc
  limit ${t}
  offset 0
)
select
  jsonb_build_object(
    'definitions', coalesce(jsonb_agg(
      jsonb_build_object(
        'id', r.id,
        'sql', r.sql
      )
    ), '[]'::jsonb)
  ) "data"
from records r;
  `.trim())({schemas:n,limit:s}),{result:r}=await (0,S.executeSql)({projectRef:e,connectionString:t,sql:i,queryKey:["entity-definitions",n]},a);return r[0].data.definitions}var _=e.i(234745),N=e.i(915993),v=e.i(150671),C=e.i(617361),E=e.i(162082),L=e.i(552423),T=e.i(124416),k=e.i(265735),R=e.i(635494),I=e.i(10429),q=e.i(887093),A=e.i(48189),D=e.i(432478),M=e.i(908937),P=e.i(317040),K=e.i(189329),O=e.i(201461),Q=e.i(441081),z=e.i(739409),F=e.i(63519),G=e.i(837710),V=e.i(843778),$=e.i(874311),U=e.i(725805),B=e.i(613580),H=e.i(106796),Y=e.i(479095),W=e.i(466472);let X=({visible:e,hasDestructiveOperations:n,hasUpdateWithoutWhere:s,onCancel:a,onConfirm:i})=>(0,t.jsxs)(W.default,{visible:e,size:"large",title:`Potential issue${n&&s?"s":""} detected with your query`,confirmLabel:"Run this query",variant:"warning",alert:{base:{variant:"warning"},title:n&&s?"The following potential issues have been detected:":"The following potential issue has been detected:",description:"Ensure that these are intentional before executing this query"},onCancel:a,onConfirm:i,children:[(0,t.jsx)("div",{className:"text-sm",children:(0,t.jsxs)("ul",{className:"border rounded-md grid bg-surface-200",children:[n&&(0,t.jsxs)("li",{className:"grid pt-3 pb-2 px-4",children:[(0,t.jsx)("span",{className:"font-bold",children:"Query has destructive operation"}),(0,t.jsx)("span",{className:"text-foreground-lighter",children:"Make sure you are not accidentally removing something important."})]}),n&&s&&(0,t.jsx)(Y.Separator,{}),s&&(0,t.jsxs)("li",{className:"grid pt-2 pb-3 px-4 gap-1",children:[(0,t.jsx)("span",{className:"font-bold",children:"Query uses update without a where clause"}),(0,t.jsxs)("span",{className:"text-foreground-lighter",children:["Without a ",(0,t.jsx)("code",{className:"text-code-inline",children:"where"})," clause, this could update all rows in the table."]})]})]})}),(0,t.jsx)("p",{className:"mt-4 text-sm text-foreground-light",children:"Please confirm that you would like to execute this query."})]});var J=e.i(260305),Z=e.i(210928),ee=e.i(888738),et=e.i(884892);function en(e){return e.replace(/^\"/,"").replace(/\"$/,"").replace(/\"\"/,'"')}function es(e){return e!=e.toLowerCase()?`"${e}"`:e}var ea=e.i(869922);async function ei({projectRef:e,connectionString:t},n){let{result:s}=await (0,S.executeSql)({projectRef:e,connectionString:t,sql:`
SELECT word FROM pg_get_keywords();
`.trim(),queryKey:["keywords"]},n);return s.map(e=>e.word.toLocaleLowerCase())}var er=e.i(801834),el=e.i(926077),eo=e.i(106579),ec=e.i(420985),ed=e.i(283606),eu=e.i(314805),em=e.i(408279),eh=e.i(500850),ep=e.i(55956),eg=e.i(388019);let ex=(0,eg.default)("ArrowUpDown",[["path",{d:"m21 16-4 4-4-4",key:"f6ql7i"}],["path",{d:"M17 20V4",key:"1ejh1v"}],["path",{d:"m3 8 4-4 4 4",key:"11wl7u"}],["path",{d:"M7 4v16",key:"1glfcx"}]]);var ef=e.i(975924),ey=e.i(215312),eS=e.i(886554),eb=e.i(414833),ej=e.i(587433),ew=e.i(34411),e_=e.i(9679),eN=e.i(451031),ev=e.i(57492),eC=e.i(831927),eE=e.i(156722),eL=e.i(449123),eT=e.i(710483);let ek=["number","string","date"],eR=({results:e={rows:[]},config:n,onConfigChange:a})=>{var l;let o,{ref:c}=(0,r.useParams)(),[d,u]=(0,T.useLocalStorageQuery)(h.LOCAL_STORAGE_KEYS.SQL_EDITOR_SQL_BLOCK_ACKNOWLEDGED(c),!1),m=(0,i.useMemo)(()=>Object.keys(e.rows[0]||{}).filter(t=>{let n=typeof e.rows[0][t];return ek.includes(n)}),[e]),p=(0,i.useMemo)(()=>e.rows[0]?Object.keys(e.rows[0]).filter(t=>{let n=e.rows[0][t];return"number"==typeof n||!isNaN(Number(n))}):[],[e]),g=n.xKey&&n.yKey,x=(0,i.useMemo)(()=>{if(!g)return!1;let t=typeof e.rows[0]?.[n.xKey],s=typeof e.rows[0]?.[n.yKey];return"number"===t&&"number"===s},[g,e.rows,n.xKey,n.yKey]),f=(0,i.useMemo)(()=>e?.rows?.length?e.rows.reduce((e,t)=>{let s=e[e.length-1]||{};return[...e,{...t,[n.yKey]:(s[n.yKey]||0)+t[n.yKey]}]},[]):[],[e,n]),y=n.cumulative?f:e.rows,S=(l=n.xKey,"number"==typeof(o=y?.[0]?.[l]||"")?"number":(0,ep.default)(o).isValid()?"date":"string");return m.length?(0,t.jsxs)(U.ResizablePanelGroup,{direction:"horizontal",className:"flex-grow h-full",children:[(0,t.jsx)(U.ResizablePanel,{className:"p-4 h-full",defaultSize:75,children:g?"bar"===n.type?(0,t.jsx)(eS.default,{showLegend:!0,size:"normal",xAxisIsDate:"date"===S,data:y,xAxisKey:n.xKey,yAxisKey:n.yKey,showGrid:n.showGrid,XAxisProps:{angle:0,interval:"preserveStart",hide:!n.showLabels,tickFormatter:e=>{let t=y[+e][n.xKey];return"date"===S?(0,ep.default)(t).format("MMM D YYYY HH:mm"):t}},YAxisProps:{tickFormatter:e=>e.toLocaleString(),hide:!n.showLabels,domain:[0,"dataMax"]}}):null:(0,t.jsx)(U.ResizablePanel,{className:"p-4 h-full",defaultSize:75,children:(0,t.jsx)(eb.default,{size:"normal",title:"Configure your chart",description:"Select your X and Y axis in the chart options panel"})})}),(0,t.jsx)(U.ResizableHandle,{withHandle:!0}),(0,t.jsxs)(U.ResizablePanel,{defaultSize:25,minSize:15,className:"px-3 py-3 space-y-4 !overflow-y-auto",children:[(0,t.jsxs)("div",{className:"flex justify-between items-center h-5",children:[(0,t.jsx)("h2",{className:"text-sm text-foreground-lighter",children:"Chart options"}),n.xKey&&n.yKey&&(0,t.jsx)(ey.ButtonTooltip,{type:"text",size:"tiny",onClick:()=>{let e=n.xKey,t=n.yKey;a({...n,xKey:t,yKey:e})},disabled:!x,icon:(0,t.jsx)(ex,{size:"15",className:"text-foreground-lighter"}),tooltip:{content:{side:"bottom",className:"w-64 text-center",text:x?"Swap X and Y axis":"Unable to swap X and Y axis - both axes need to numerical values"}},children:"Flip"})]}),!d&&(0,t.jsxs)(eT.Admonition,{showIcon:!1,type:"tip",className:"p-2 relative group",children:[(0,t.jsxs)(B.Tooltip,{children:[(0,t.jsx)(B.TooltipTrigger,{onClick:()=>u(!0),className:"absolute top-3 right-3 opacity-30 group-hover:opacity-100 transition-opacity",children:(0,t.jsx)(ef.X,{size:14,className:"text-foreground-light"})}),(0,t.jsx)(B.TooltipContent,{side:"bottom",children:"Dismiss"})]}),(0,t.jsxs)("div",{className:"flex items-center gap-x-2",children:[(0,t.jsx)(ej.Badge,{variant:"success",children:"New"}),(0,t.jsx)("p",{className:"text-xs",children:"Add this chart to custom reports"})]}),(0,t.jsx)("p",{className:"text-xs text-foreground-light !mt-1",children:"SQL snippets can now be added and saved to your custom reports. Try it out now!"}),(0,t.jsx)(G.Button,{asChild:!0,size:"tiny",type:"default",className:"mt-1",children:(0,t.jsx)(s.default,{href:`/project/${c}/reports`,children:"Head to Reports"})})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)(e_.Label_Shadcn_,{className:"text-xs text-foreground-light",children:"X Axis"}),(0,t.jsxs)(eL.Select_Shadcn_,{value:n.xKey,onValueChange:e=>{a({...n,xKey:e})},children:[(0,t.jsx)(eE.SelectTrigger_Shadcn_,{children:n.xKey||"Select X Axis"}),(0,t.jsx)(eN.SelectContent_Shadcn_,{children:(0,t.jsx)(ev.SelectGroup_Shadcn_,{children:m.map(e=>(0,t.jsx)(eC.SelectItem_Shadcn_,{value:e,children:e},e))})})]})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)(e_.Label_Shadcn_,{className:"text-xs text-foreground-light",children:"Y Axis"}),(0,t.jsxs)(eL.Select_Shadcn_,{value:n.yKey,onValueChange:e=>{a({...n,yKey:e})},children:[(0,t.jsx)(eE.SelectTrigger_Shadcn_,{children:n.yKey||"Select Y Axis"}),(0,t.jsx)(eN.SelectContent_Shadcn_,{children:(0,t.jsx)(ev.SelectGroup_Shadcn_,{children:p.map(e=>(0,t.jsx)(eC.SelectItem_Shadcn_,{value:e,children:e},e))})})]})]}),(0,t.jsxs)("div",{className:"*:flex *:gap-2 *:items-center grid gap-2 *:text-foreground-light *:p-1.5 *:pl-0",children:[(0,t.jsxs)(e_.Label_Shadcn_,{className:"",htmlFor:"cumulative",children:[(0,t.jsx)(ew.Checkbox_Shadcn_,{id:"cumulative",name:"cumulative",checked:n.cumulative,onClick:()=>a({...n,cumulative:!n.cumulative})}),"Cumulative"]}),(0,t.jsxs)(e_.Label_Shadcn_,{htmlFor:"showLabels",children:[(0,t.jsx)(ew.Checkbox_Shadcn_,{id:"showLabels",name:"showLabels",checked:n.showLabels,onClick:()=>a({...n,showLabels:!n.showLabels})}),"Show labels"]}),(0,t.jsxs)(e_.Label_Shadcn_,{htmlFor:"showGrid",children:[(0,t.jsx)(ew.Checkbox_Shadcn_,{id:"showGrid",name:"showGrid",checked:n.showGrid,onClick:()=>a({...n,showGrid:!n.showGrid})}),"Show grid"]})]})]})]}):(0,t.jsx)("div",{className:"p-2",children:(0,t.jsx)(eb.default,{size:"normal",description:"Execute a query and configure the chart options."})})};var eI=e.i(419524),eq=e.i(370410),eA=e.i(718726);let eD=(0,eg.default)("Keyboard",[["path",{d:"M10 8h.01",key:"1r9ogq"}],["path",{d:"M12 12h.01",key:"1mp3jc"}],["path",{d:"M14 8h.01",key:"1primd"}],["path",{d:"M16 12h.01",key:"1l6xoz"}],["path",{d:"M18 8h.01",key:"emo2bl"}],["path",{d:"M6 8h.01",key:"x9i8wu"}],["path",{d:"M7 16h10",key:"wp8him"}],["path",{d:"M8 12h.01",key:"czm47f"}],["rect",{width:"20",height:"16",x:"2",y:"4",rx:"2",key:"18n3k1"}]]);var eM=e.i(471998),eP=e.i(686415),eK=e.i(282492),eO=e.i(362988),eQ=e.i(867637),ez=e.i(740010);let eF=({id:e})=>{let{profile:n}=(0,D.useProfile)(),s=(0,z.useSqlEditorV2StateSnapshot)().snippets[e],a=n?.id===s?.snippet.owner_id;return(0,t.jsx)(t.Fragment,{children:a?null:(0,t.jsx)(ej.Badge,{children:"Read-only"})})},eG=({id:e})=>{let{profile:s}=(0,D.useProfile)(),a=(0,z.useSqlEditorV2StateSnapshot)(),r=a.savingStates[e],l=(0,n.usePrevious)(r),[o,d]=(0,i.useState)(!1),u=a.snippets[e],m=s?.id===u?.snippet.owner_id;return(0,i.useEffect)(()=>{let e=!1;return"UPDATING"===l&&"IDLE"===r&&(d(!0),setTimeout(()=>{e||d(!1)},5e3)),()=>{e=!0}},[r]),(0,t.jsx)(t.Fragment,{children:(0,t.jsxs)("div",{className:"mx-2 flex items-center gap-2",children:[m&&"UPDATING_FAILED"===r&&(0,t.jsx)(G.Button,{type:"text",size:"tiny",icon:(0,t.jsx)(ez.RefreshCcw,{className:"text-gray-1100",strokeWidth:2}),onClick:()=>a.addNeedsSaving(e),children:"Retry"}),o?(0,t.jsxs)(B.Tooltip,{children:[(0,t.jsx)(B.TooltipTrigger,{children:(0,t.jsx)(eq.Check,{className:"text-brand",size:14,strokeWidth:3})}),(0,t.jsx)(B.TooltipContent,{side:"bottom",children:"All changes saved"})]}):"UPDATING"===r?(0,t.jsxs)(B.Tooltip,{children:[(0,t.jsx)(B.TooltipTrigger,{children:(0,t.jsx)(c.Loader2,{className:"animate-spin",size:14,strokeWidth:2})}),(0,t.jsx)(B.TooltipContent,{children:"Saving changes..."})]}):"UPDATING_FAILED"===r?m?(0,t.jsxs)(B.Tooltip,{children:[(0,t.jsx)(B.TooltipTrigger,{children:(0,t.jsx)(eQ.AlertCircle,{className:"text-red-900",size:14,strokeWidth:2})}),(0,t.jsx)(B.TooltipContent,{children:"Failed to save changes"})]}):(0,t.jsx)(eF,{id:e}):null]})})},eV=({id:e,isExecuting:n=!1,isDisabled:s=!1,hasSelection:a=!1,prettifyQuery:i,executeQuery:l})=>{let{ref:o}=(0,r.useParams)(),c=(0,z.useSqlEditorV2StateSnapshot)(),[d]=(0,T.useLocalStorageQuery)(h.LOCAL_STORAGE_KEYS.SQL_EDITOR_AI_OPEN,!0),[m,p]=(0,T.useLocalStorageQuery)(h.LOCAL_STORAGE_KEYS.SQL_EDITOR_INTELLISENSE,!0),[g,x]=(0,T.useLocalStorageQuery)(h.LOCAL_STORAGE_KEYS.SQL_EDITOR_LAST_SELECTED_DB(o),""),f=c.snippets[e],y=void 0!==f&&f.snippet.favorite,S=()=>{p(!m),u.toast.success(`Successfully ${m?"disabled":"enabled"} intellisense. ${m?"Please refresh your browser for changes to take place.":""}`)},b=()=>c.addFavorite(e),j=()=>c.removeFavorite(e);return(0,t.jsxs)("div",{className:"inline-flex items-center justify-end gap-x-2",children:[I.IS_PLATFORM&&(0,t.jsx)(eG,{id:e}),(0,t.jsxs)($.DropdownMenu,{children:[(0,t.jsx)($.DropdownMenuTrigger,{asChild:!0,children:(0,t.jsx)(G.Button,{"data-testid":"sql-editor-utility-actions",type:"default",className:(0,V.cn)("px-1",d?"block 2xl:hidden":"hidden"),icon:(0,t.jsx)(eM.MoreVertical,{className:"text-foreground-light"})})}),(0,t.jsxs)($.DropdownMenuContent,{className:"w-48",children:[(0,t.jsxs)($.DropdownMenuItem,{className:"justify-between",onClick:S,children:[(0,t.jsxs)("span",{className:"flex items-center gap-x-2",children:[(0,t.jsx)(eD,{size:14,className:"text-foreground-light"}),"Intellisense enabled"]}),m&&(0,t.jsx)(eq.Check,{className:"text-brand",size:16})]}),I.IS_PLATFORM&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)($.DropdownMenuSeparator,{}),(0,t.jsxs)($.DropdownMenuItem,{className:"gap-x-2",onClick:()=>{y?j():b()},children:[(0,t.jsx)(eA.Heart,{size:14,strokeWidth:2,className:y?"fill-brand stroke-none":"fill-none stroke-foreground-light"}),y?"Remove from":"Add to"," favorites"]})]}),(0,t.jsxs)($.DropdownMenuItem,{className:"gap-x-2",onClick:i,children:[(0,t.jsx)(eI.AlignLeft,{size:14,strokeWidth:2,className:"text-foreground-light"}),"Prettify SQL"]})]})]}),(0,t.jsxs)("div",{className:(0,V.cn)("items-center gap-x-2",d?"hidden 2xl:flex":"flex"),children:[(0,t.jsxs)($.DropdownMenu,{children:[(0,t.jsx)($.DropdownMenuTrigger,{asChild:!0,children:(0,t.jsx)(G.Button,{type:"text",className:"px-1",icon:(0,t.jsx)(eD,{className:"text-foreground-light"})})}),(0,t.jsx)($.DropdownMenuContent,{className:"w-48",children:(0,t.jsxs)($.DropdownMenuItem,{className:"justify-between",onClick:S,children:["Intellisense enabled",m&&(0,t.jsx)(eq.Check,{className:"text-brand",size:16})]})})]}),I.IS_PLATFORM&&(0,t.jsxs)(B.Tooltip,{children:[(0,t.jsx)(B.TooltipTrigger,{asChild:!0,children:y?(0,t.jsx)(G.Button,{type:"text",size:"tiny",onClick:j,className:"px-1",icon:(0,t.jsx)(eA.Heart,{className:"fill-brand stroke-none"})}):(0,t.jsx)(G.Button,{type:"text",size:"tiny",onClick:b,className:"px-1",icon:(0,t.jsx)(eA.Heart,{className:"fill-none stroke-foreground-light"})})}),(0,t.jsxs)(B.TooltipContent,{side:"bottom",children:[y?"Remove from":"Add to"," favorites"]})]}),(0,t.jsxs)(B.Tooltip,{children:[(0,t.jsx)(B.TooltipTrigger,{asChild:!0,children:(0,t.jsx)(G.Button,{type:"text",onClick:i,className:"px-1",icon:(0,t.jsx)(eI.AlignLeft,{strokeWidth:2,className:"text-foreground-light"})})}),(0,t.jsx)(B.TooltipContent,{side:"bottom",children:"Prettify SQL"})]})]}),(0,t.jsx)("div",{className:"flex items-center justify-between gap-x-2",children:(0,t.jsxs)("div",{className:"flex items-center",children:[I.IS_PLATFORM&&(0,t.jsx)(eK.default,{selectedDatabaseId:0===g.length?void 0:g,variant:"connected-on-right",onSelectId:t=>{c.resetResult(e),x(t)}}),(0,t.jsx)(eP.RoleImpersonationPopover,{serviceRoleLabel:"postgres",variant:I.IS_PLATFORM?"connected-on-both":"connected-on-right"}),(0,t.jsx)(eO.SqlRunButton,{hasSelection:a,isDisabled:s||n,isExecuting:n,className:"rounded-l-none min-w-[82px]",onClick:l})]})})]})};var e$=e.i(17203),eU=e.i(4196),eB=e.i(743371),eH=e.i(223600),eY=e.i(937942),eW=e.i(377451),eX=e.i(540203),eJ=e.i(602089),eZ=e.i(410339);let e0=(0,i.forwardRef)(({id:e,isExecuting:n,isDisabled:s,isDebugging:a,onDebug:i})=>{let{ref:l}=(0,r.useParams)(),o=(0,K.useDatabaseSelectorStateSnapshot)(),{data:d}=(0,k.useSelectedOrganizationQuery)(),u=(0,z.useSqlEditorV2StateSnapshot)(),[,m]=(0,eU.useQueryState)("showConnect",eU.parseAsBoolean.withDefault(!1)),h=u.results[e]?.[0],{data:p}=(0,eX.useOrgSubscriptionQuery)({orgSlug:d?.slug}),{data:g}=(0,eW.useProjectSettingsV2Query)({projectRef:l}),x=(0,eB.subscriptionHasHipaaAddon)(p)&&g?.is_sensitive,f=h?.error?.message?.includes("canceling statement due to statement timeout")||h?.error?.message?.includes("upstream request timeout")||h?.error?.message?.includes("Query read timeout"),y=h?.error?.message?.includes("EHOSTUNREACH");if(n)return(0,t.jsxs)("div",{className:"flex items-center gap-x-4 px-6 py-4 bg-table-header-light [[data-theme*=dark]_&]:bg-table-header-dark",children:[(0,t.jsx)(c.Loader2,{size:14,className:"animate-spin"}),(0,t.jsx)("p",{className:"m-0 border-0 font-mono text-sm",children:"Running..."})]});if(h?.error){let n=(h.error?.formattedError?.split("\n")??[]).filter(e=>e.length>0),r=o.selectedDatabaseId!==l&&h.error.message.includes("in a read-only transaction"),c=h.error.message.includes("Query is too large to be run via the SQL Editor");return(0,t.jsx)("div",{className:"bg-table-header-light [[data-theme*=dark]_&]:bg-table-header-dark overflow-y-auto",children:(0,t.jsxs)("div",{className:"flex flex-row justify-between items-start py-4 px-6 gap-x-4",children:[f?(0,t.jsxs)("div",{className:"flex flex-col gap-y-1",children:[(0,t.jsx)("p",{className:"font-mono text-sm tracking-tight",children:"Error: SQL query ran into an upstream timeout"}),(0,t.jsxs)("p",{className:"text-sm text-foreground-light",children:["You can either"," ",(0,t.jsx)(eY.InlineLink,{href:`${I.DOCS_URL}/guides/platform/performance#examining-query-performance`,children:"optimize your query"}),", or"," ",(0,t.jsx)(eY.InlineLink,{href:`${I.DOCS_URL}/guides/database/timeouts`,children:"increase the statement timeout"})," or ",(0,t.jsx)("span",{className:(0,V.cn)(eY.InlineLinkClassName,"cursor-pointer"),onClick:()=>m(!0),children:"connect to your database directly"}),"."]})]}):(0,t.jsxs)("div",{className:"flex flex-col gap-y-1",children:[n.length>0?n.map((e,n)=>(0,t.jsx)("pre",{className:"font-mono text-sm text-wrap",children:e},`error-${n}`)):(0,t.jsxs)("p",{className:"font-mono text-sm tracking-tight",children:["Error: ",h.error?.message]}),!f&&!y&&h.autoLimit&&(0,t.jsxs)("p",{className:"text-sm text-foreground-light",children:["Note: A limit of ",h.autoLimit,' was applied to your query. If this was the cause of a syntax error, try selecting "No limit" instead and re-run the query.']}),r&&(0,t.jsx)("p",{className:"text-sm text-foreground-light",children:"Note: Read replicas are for read only queries. Run write queries on the primary database instead."}),c&&(0,t.jsxs)("p",{className:"text-sm text-foreground-light flex items-center gap-x-1",children:["Run this query by"," ",(0,t.jsxs)("span",{onClick:()=>m(!0),className:(0,V.cn)(eY.InlineLinkClassName,"flex items-center gap-x-1"),children:["connecting to your database directly",(0,t.jsx)(e$.ExternalLink,{size:12})]}),"."]})]}),(0,t.jsxs)("div",{className:"flex items-center gap-x-2",children:[r&&(0,t.jsx)(G.Button,{className:"py-2",type:"default",onClick:()=>{o.setSelectedDatabaseId(l),u.resetResult(e)},children:"Switch to primary database"}),n.length>0&&(0,t.jsxs)(B.Tooltip,{children:[(0,t.jsx)(B.TooltipTrigger,{children:(0,t.jsx)(eH.default,{iconOnly:!0,type:"default",text:n.join("\n")})}),(0,t.jsx)(B.TooltipContent,{side:"bottom",align:"center",children:(0,t.jsx)("span",{children:"Copy error"})})]}),!x&&(0,t.jsx)(G.Button,{icon:(0,t.jsx)(eJ.AiIconAnimation,{size:16,loading:a}),disabled:!!s||a,onClick:i,children:"Debug with Assistant"})]})]})})}return h?h.rows.length<=0?(0,t.jsx)("div",{className:"bg-table-header-light [[data-theme*=dark]_&]:bg-table-header-dark overflow-y-auto",children:(0,t.jsx)("p",{className:"m-0 border-0 px-6 py-4 font-mono text-sm",children:"Success. No rows returned"})}):(0,t.jsx)(eZ.default,{rows:h.rows}):(0,t.jsx)("div",{className:"bg-table-header-light [[data-theme*=dark]_&]:bg-table-header-dark overflow-y-auto",children:(0,t.jsxs)("p",{className:"m-0 border-0 px-4 py-4 text-sm text-foreground-light",children:["Click ",(0,t.jsx)("code",{children:"Run"})," to execute your query."]})})});e0.displayName="UtilityTabResults";let e1={type:"bar",cumulative:!1,xKey:"",yKey:"",showLabels:!1,showGrid:!1},e2=({id:e,isExecuting:n,isDebugging:s,isDisabled:a,hasSelection:i,prettifyQuery:l,executeQuery:o,onDebug:c})=>{let{ref:d}=(0,r.useParams)(),{data:m}=(0,k.useSelectedOrganizationQuery)(),h=(0,z.useSqlEditorV2StateSnapshot)(),p=h.snippets[e]?.snippet,g=h.results[e]?.[0],{mutate:x}=(0,E.useSendEventMutation)(),{mutate:f}=(0,ec.useContentUpsertMutation)({invalidateQueriesOnSuccess:!1,onMutate:async t=>{let{payload:n}=t;if("sql"!==n.type||!("chart"in n.content))return;let s={...p,content:{...p.content,chart:n.content.chart}};h.updateSnippet({id:e,snippet:s})},onError:async(e,t,n)=>{u.toast.error("Failed to update chart. Please try again.")}}),y=p&&"sql"===p.type&&p.content?.chart?p.content.chart:e1;return(0,t.jsxs)(eh.Tabs_Shadcn_,{defaultValue:"results",className:"w-full h-full flex flex-col",children:[(0,t.jsxs)(eu.TabsList_Shadcn_,{className:"flex justify-between gap-2 px-4 overflow-x-auto min-h-[42px]",children:[(0,t.jsxs)("div",{className:"flex items-center gap-4",children:[(0,t.jsx)(em.TabsTrigger_Shadcn_,{className:"py-3 text-xs",value:"results",children:(0,t.jsx)("span",{className:"translate-y-[1px]",children:"Results"})}),(0,t.jsx)(em.TabsTrigger_Shadcn_,{className:"py-3 text-xs",value:"chart",children:(0,t.jsx)("span",{className:"translate-y-[1px]",children:"Chart"})}),g?.rows&&(0,t.jsx)(eo.DownloadResultsButton,{type:"text",results:g.rows,fileName:`Supabase Snippet ${p.name}`,onDownloadAsCSV:()=>x({action:"sql_editor_result_download_csv_clicked",groups:{project:d??"",organization:m?.slug??""}}),onCopyAsMarkdown:()=>{x({action:"sql_editor_result_copy_markdown_clicked",groups:{project:d??"",organization:m?.slug??""}})},onCopyAsJSON:()=>{x({action:"sql_editor_result_copy_json_clicked",groups:{project:d??"",organization:m?.slug??""}})}})]}),(0,t.jsx)(eV,{id:e,isExecuting:n,isDisabled:a,hasSelection:i,prettifyQuery:l,executeQuery:o})]}),(0,t.jsx)(ed.TabsContent_Shadcn_,{asChild:!0,value:"results",className:"mt-0 flex-grow",children:(0,t.jsx)(e0,{id:e,isExecuting:n,isDisabled:a,onDebug:c,isDebugging:s})}),(0,t.jsx)(ed.TabsContent_Shadcn_,{asChild:!0,value:"chart",className:"mt-0 flex-grow",children:(0,t.jsx)(eR,{results:g,config:y,onConfigChange:function(t){d&&p?.id&&f({projectRef:d,payload:{...p,id:p.id,description:p.description||"",project_id:p.project_id||0,content:{...p.content,content_id:e,chart:t}}})}})})]})},e4=(0,d.default)(()=>e.A(281524),{loadableGenerated:{modules:[496981]},ssr:!1}),e3=(0,d.default)(()=>e.A(803957).then(({DiffEditor:e})=>e),{loadableGenerated:{modules:[409735]},ssr:!1}),e8=()=>{let e=(0,A.detectOS)(),n=(0,a.useRouter)(),{ref:s,id:d}=(0,r.useParams)(),{profile:S}=(0,D.useProfile)(),{data:b}=(0,R.useSelectedProjectQuery)(),{data:Y}=(0,k.useSelectedOrganizationQuery)(),W=(0,l.useQueryClient)(),eo=(0,F.useTabsStateSnapshot)(),ec=(0,P.useAiAssistantStateSnapshot)(),{openSidebar:ed}=(0,Q.useSidebarManagerSnapshot)(),eu=(0,z.useSqlEditorV2StateSnapshot)(),em=(0,O.useGetImpersonatedRoleState)(),eh=(0,K.useDatabaseSelectorStateSnapshot)(),{includeSchemaMetadata:ep,isHipaaProjectDisallowed:eg}=(0,L.useOrgAiOptInLevel)(),[ex]=function(e){let[t,n]=(0,T.useLocalStorageQuery)(h.LOCAL_STORAGE_KEYS.SQL_EDITOR_AI_SCHEMA(e),["public"]);return e?[t,n]:[[],()=>{}]}(b?.ref),{sourceSqlDiff:ef,setSourceSqlDiff:ey,selectedDiffType:eS,setSelectedDiffType:eb,setIsAcceptDiffLoading:ej,isDiffOpen:ew,defaultSqlDiff:e_,closeDiff:eN}=(0,H.useSqlEditorDiff)(),{promptState:ev,setPromptState:eC,promptInput:eE,setPromptInput:eL,resetPrompt:eT}=(0,H.useSqlEditorPrompt)(),ek=(0,i.useRef)(null),eR=(0,i.useRef)(null),eI=(0,i.useRef)(null),eq=(0,i.useRef)(0),[eA,eD]=(0,i.useState)(!1),[eM,eP]=(0,i.useState)([]),[eK,eO]=(0,i.useState)(!1),[eQ,ez]=(0,i.useState)(!1),[eF,eG]=(0,i.useState)(!1),[eV,e$]=(0,i.useState)(!1),[eU,eB]=(0,i.useState)(!1),eH=(0,i.useMemo)(()=>(0,A.uuidv4)(),[d]),eY=d&&"new"!==d?d:eH,eW=eu.limit,eX=eu.results[eY]?.[0],eJ=!(eY in eu.snippets&&void 0!==eu.snippets[eY].snippet.content),eZ="new"!==d&&eJ;((e,t)=>{let{data:n}=(0,R.useSelectedProjectQuery)(),s=(0,z.useSqlEditorV2StateSnapshot)(),[a]=(0,T.useLocalStorageQuery)(h.LOCAL_STORAGE_KEYS.SQL_EDITOR_INTELLISENSE,!0),{data:r,isSuccess:l}=(({projectRef:e,connectionString:t},{enabled:n=!0,...s}={})=>(0,y.useQuery)({queryKey:j.databaseKeys.keywords(e),queryFn:({signal:n})=>ei({projectRef:e,connectionString:t},n),enabled:n&&void 0!==e,...s}))({projectRef:n?.ref,connectionString:n?.connectionString},{enabled:a}),{data:o,isSuccess:c}=(0,ea.useDatabaseFunctionsQuery)({projectRef:n?.ref,connectionString:n?.connectionString},{enabled:a}),{data:d,isSuccess:u}=(0,er.useSchemasQuery)({projectRef:n?.ref,connectionString:n?.connectionString},{enabled:a}),{data:m,isSuccess:p}=(0,el.useTableColumnsQuery)({projectRef:n?.ref,connectionString:n?.connectionString},{enabled:a}),g=(0,i.useRef)(null),x=a&&p&&u&&l&&c;x&&(null===g.current&&(g.current={}),g.current.tableColumns=m,g.current.schemas=d,g.current.keywords=r,g.current.functions=o),(0,i.useEffect)(()=>{if(t){let n=t.languages.registerDocumentFormattingEditProvider("pgsql",{async provideDocumentFormattingEdits(t){let n=t.getValue(),a=(0,q.formatSql)(n);return e&&s.setSql(e,a),[{range:t.getFullModelRange(),text:a}]}});return()=>n.dispose()}},[t]),(0,i.useEffect)(()=>{let e=null,n=null;x&&t&&x&&(e=t.languages.registerCompletionItemProvider("pgsql",{triggerCharacters:[" ",".",'"'],provideCompletionItems:function(e,n,s){try{let c=new et.default(e,n.column-2,n.lineNumber-1);if('"'===s.triggerCharacter){var a,i,r=t,l=g,o=c;let e=[];if(!o.isFowardDQuote())return{suggestions:e};if(o.next(),o.isNextPeriod()){let t=o.readIdent(),n=!1;t.match(/^\".*?\"$/)&&(n=!0,t=en(t));let s=l.current.tableColumns.find(e=>n&&e.tablename===t||!n&&e.tablename.toLocaleLowerCase()==t.toLocaleLowerCase());if(!s)return{suggestions:e};s.columns.forEach(t=>{e.push({label:t.attname,kind:r.languages.CompletionItemKind.Property,detail:t.data_type,insertText:t.attname})})}else l.current.tableColumns.forEach(t=>{e.push({label:t.tablename,kind:r.languages.CompletionItemKind.Class,insertText:t.tablename})});return{suggestions:e}}if("."===s.triggerCharacter)return function(e,t,n){var s,a;let i=[],r=(s=n,a=3,s.readIdents(3).map(e=>{let t=!1;return e.match(/^\".*?\"$/)&&(t=!0,e=en(e)),{isQuoted:t,name:e}})),l=0,o=t.current.schemas.find(e=>{let t=r&&r.length>l?r[l]:{};return t.isQuoted&&e.name===t.name||!t.isQuoted&&e.name?.toLocaleLowerCase()==t.name?.toLocaleLowerCase()});if(o?l++:o=t.current.schemas.find(e=>"public"==e.name),r.length==l)return t.current.tableColumns.forEach(t=>{t.schemaname==o.name&&i.push({label:t.tablename,kind:e.languages.CompletionItemKind.Class,detail:"public"!==t.schemaname?t.schemaname:null,insertText:es(t.tablename)})}),{suggestions:i};let c=t.current.tableColumns.find(e=>{let t=r&&r.length>l?r[l]:{};return e.schemaname==o.name&&t.isQuoted&&e.tablename===t.name||!t.isQuoted&&e.tablename?.toLocaleLowerCase()==t.name?.toLocaleLowerCase()});return c&&c.columns.forEach(t=>{i.push({label:t.attname,kind:e.languages.CompletionItemKind.Property,detail:t.data_type,insertText:es(t.attname)})}),{suggestions:i}}(t,g,c);{let e;return a=t,i=g,e=[],i.current.keywords?.length>0&&i.current.keywords.forEach(t=>{e.push({label:t,kind:a.languages.CompletionItemKind.Keyword,insertText:t})}),i.current.schemas?.length>0&&i.current.schemas.forEach(t=>{e.push({label:t.name,kind:a.languages.CompletionItemKind.Keyword,insertText:t.name})}),i.current.tableColumns?.length>0&&i.current.tableColumns.forEach(t=>{let n="public"==t.schemaname?t.tablename:t.schemaname+"."+t.tablename;e.push({label:t.tablename,detail:"public"!==t.schemaname?t.schemaname:null,kind:t.is_table?a.languages.CompletionItemKind.Class:a.languages.CompletionItemKind.Interface,insertText:es(n)}),t.columns.forEach(n=>{if(!n)return;let s=e.find(e=>e.label===n?.attname&&e.kind===a.languages.CompletionItemKind.Field&&e.detail===n?.data_type);s?(s.tables.push(t.tablename),s.tables.sort(),s.documentation=s.tables.join(", ")):e.push({label:n.attname,kind:a.languages.CompletionItemKind.Field,detail:n.data_type,documentation:t.tablename,tables:[t.tablename],insertText:es(n.attname)})})}),i.current.functions?.length>0&&i.current.functions.forEach(t=>{e.push({label:t.name,kind:a.languages.CompletionItemKind.Function,detail:t.return_type,insertText:t.name})}),{suggestions:e}}}catch(e){return{suggestions:[]}}}}),n=t.languages.registerSignatureHelpProvider("pgsql",{signatureHelpTriggerCharacters:["(",","],provideSignatureHelp:function(e,t){let n=new et.default(e,t.column-2,t.lineNumber-1),s=n.readArguments();if(s<0)return null;let a=n.readIdent();if(!a||a.match(/^\".*?\"$/))return null;let i=g.current.functions.find(e=>e.name.toLocaleLowerCase()===a.toLocaleLowerCase());if(!i||!i.args||i.args.length<s)return null;let r=Math.min(s,i.args.length-1),l=[];return l.push({label:`${i.name}(${i.argument_types})`,parameters:i.args.map(e=>({label:e.name}))}),{value:{signatures:l,activeSignature:0,activeParameter:r},dispose:()=>{}}}}));return()=>{e?.dispose(),n?.dispose()}},[x,t])})(eY,eR.current);let{data:e0,isSuccess:e1}=(0,v.useReadReplicasQuery)({projectRef:s},{enabled:(0,_.isValidConnString)(b?.connectionString)}),{data:e8,refetch:e9}=(({projectRef:e,connectionString:t,schemas:n,limit:s},{enabled:a=!0,...i}={})=>(0,y.useQuery)({queryKey:j.databaseKeys.entityDefinitions(e,n),queryFn:({signal:a})=>w({projectRef:e,connectionString:t,schemas:n,limit:s},a),enabled:a&&void 0!==e&&n.length>0,...i}))({schemas:ex,projectRef:b?.ref,connectionString:b?.connectionString},{enabled:(0,_.isValidConnString)(b?.connectionString)&&ep}),e6=ep?e8?.map(e=>e.sql.trim()):void 0,{mutateAsync:e7}=(0,f.useSqlTitleGenerateMutation)(),{mutate:e5}=(0,E.useSendEventMutation)(),{mutate:te,isPending:tt}=(0,C.useExecuteSqlMutation)({onSuccess(e,t){eY&&eu.addResult(eY,e.result,t.autoLimit),e9(),W.invalidateQueries({queryKey:N.lintKeys.lint(s)})},onError(e,t){if(eY){if(e.position&&eR.current){let t=ek.current,n=eR.current,s=eA?t?.getSelection()?.startLineNumber??0:0,a=e.formattedError??"",i=a.slice(a.indexOf("LINE")),r=s+Number(i.slice(0,i.indexOf(":")).split(" ")[1]);if(!isNaN(r)){let e=t?.deltaDecorations([],[{range:new n.Range(r,1,r,20),options:{isWholeLine:!0,inlineClassName:"bg-warning-400"}}]);e&&(t?.revealLineInCenter(r),eP(e))}}eu.addResultError(eY,e,t.autoLimit)}}}),tn=(0,i.useCallback)(async(e,t)=>{try{let{title:n}=await e7({sql:t});eu.renameSnippet({id:e,name:n});let s=(0,F.createTabId)("sql",{id:e});eo.updateTab(s,{label:n})}catch(e){}},[e7,eu]),ts=(0,i.useCallback)(async()=>{if(ew)return;let e=(0,z.getSqlEditorV2StateSnapshot)().snippets[eY];if(ek.current&&b){let t=ek.current,n=t.getSelection(),s=n?t.getModel()?.getValueInRange(n):void 0,a=e?(s||ek.current?.getValue())??e.snippet.content?.sql:s||ek.current?.getValue(),i=(0,q.formatSql)(a),r=ek?.current?.getModel();ek.current&&r&&(ek.current.executeEdits("apply-prettify-edit",[{text:i,range:r.getFullModelRange()}]),eu.setSql(eY,i))}},[eY,ew,b,eu]),ta=(0,i.useCallback)(async(e=!1)=>{if(ew)return;let t=(0,z.getSqlEditorV2StateSnapshot)().snippets[eY];if(null!==ek.current&&!tt&&void 0!==b){let n=ek.current,a=n.getSelection(),i=a?n.getModel()?.getValueInRange(a):void 0,r=t?(i||ek.current?.getValue())??t.snippet.content?.sql:i||ek.current?.getValue(),l=!1,o=(0,ee.checkDestructiveQuery)(r);!e&&o&&(ez(!0),eG(!0),l=!0);let c=(0,ee.isUpdateWithoutWhere)(r);if(!e&&c&&(ez(!0),e$(!0),l=!0),l)return;!eg&&t?.snippet.name.startsWith(J.untitledSnippetTitle)&&m.IS_PLATFORM&&tn(eY,r),eM.length>0&&(n?.deltaDecorations(eM,[]),eP([]));let d=em(),h=e0?.find(e=>e.identifier===eh.selectedDatabaseId)?.connectionString;if(!(0,_.isValidConnString)(h))return u.toast.error("Unable to run query: Connection string is missing");let{appendAutoLimit:p}=(0,ee.checkIfAppendLimitRequired)(r,eW),g=(0,ee.suffixWithLimit)(r,eW);te({projectRef:b.ref,connectionString:h,sql:(0,M.wrapWithRoleImpersonation)(g,d),autoLimit:p?eW:void 0,isRoleImpersonationEnabled:(0,O.isRoleImpersonationEnabled)(d.role),isStatementTimeoutDisabled:!0,contextualInvalidation:!0,handleError:e=>{throw e}}),e5({action:"sql_editor_query_run_button_clicked",groups:{project:s??"Unknown",organization:Y?.slug??"Unknown"}})}},[ew,eY,tt,b,eg,te,em,tn,eh.selectedDatabaseId,e0,eW]),ti=(0,i.useCallback)(async(e,t)=>{if(!s)return console.error("Project ref is required");if(!S)return console.error("Profile is required");if(!b)return console.error("Project is required");try{let a=(0,ee.createSqlSnippetSkeletonV2)({id:(0,A.uuidv4)(),name:t,sql:e,owner_id:S.id,project_id:b.id});eu.addSnippet({projectRef:s,snippet:a}),eu.addNeedsSaving(a.id),n.push(`/project/${s}/sql/${a.id}`)}catch(e){u.toast.error(`Failed to create new query: ${e.message}`)}},[S?.id,b?.id,s,n,eu]),tr=(0,i.useCallback)(async()=>{try{let e=eu.snippets[eY],t=eu.results[eY]?.[0];ed(p.SIDEBAR_KEYS.AI_ASSISTANT),ec.newChat({name:"Debug SQL snippet",sqlSnippets:[(e.snippet.content?.sql??"").replace(J.sqlAiDisclaimerComment,"").trim()],initialInput:`Help me to debug the attached sql snippet which gives the following error: 

${t.error.message}`})}catch(e){e&&"object"==typeof e&&"message"in e&&"string"==typeof e.message&&u.toast.error("Sorry, the assistant failed to debug your query! Please try again with a different one.")}},[e6,eY,eu.results,eu.snippets]),tl=(0,i.useCallback)(async()=>{try{if(ej(!0),!ef||!ek.current||!eI.current)return;let e=ek.current.getModel(),t=eI.current.getModel();if(!e||!t)return;let n=t.modified.getValue();if(eS===Z.DiffType.NewSnippet){let{title:e}=await e7({sql:n});await ti(n,e)}else ek.current.executeEdits("apply-ai-edit",[{text:n,range:e.getFullModelRange()}]);e5({action:"assistant_sql_diff_handler_evaluated",properties:{handlerAccepted:!0},groups:{project:s??"Unknown",organization:Y?.slug??"Unknown"}}),eb(Z.DiffType.Modification),eT(),eN()}finally{ej(!1)}},[ef,eS,ti,e7,n,eY,eu]),to=(0,i.useCallback)(()=>{e5({action:"assistant_sql_diff_handler_evaluated",properties:{handlerAccepted:!1},groups:{project:s??"Unknown",organization:Y?.slug??"Unknown"}}),eT(),eN()},[eN,eT,e5]),[tc,td]=(0,i.useState)(!1),tu=(0,i.useCallback)(async(e,t)=>{try{td(!0);let e=await fetch(`${I.BASE_PATH}/api/ai/code/complete`,{method:"POST",headers:{"Content-Type":"application/json",...t?.headers??{}},body:JSON.stringify({projectRef:b?.ref,connectionString:b?.connectionString,language:"sql",orgSlug:Y?.slug,...t?.body??{}})});if(!e.ok){let t=await e.text();throw Error(t||"Failed to generate completion")}let n=await e.json(),s=t?.body?.completionMetadata??{},a=s.textBeforeCursor??"",i=s.textAfterCursor??"",r=s.selection??"",l=(0,q.formatSql)(a+n+i);ey({original:a+r+i,modified:l}),eb(Z.DiffType.Modification),eC(e=>({...e,isLoading:!1})),td(!1)}catch(e){throw u.toast.error(`Failed to generate SQL: ${e?.message??"Unknown error"}`),td(!1),e}},[Y?.slug,b?.connectionString,b?.ref,eC,eb,ey]),tm=async(e,t)=>{try{eC(e=>({...e,selection:t.selection,beforeSelection:t.beforeSelection,afterSelection:t.afterSelection}));let n=(await (0,_.constructHeaders)()).get("Authorization");await tu(e,{...n?{headers:{Authorization:n}}:void 0,body:{completionMetadata:{textBeforeCursor:t.beforeSelection,textAfterCursor:t.afterSelection,language:"pgsql",prompt:e,selection:t.selection}}})}catch(e){eC(e=>({...e,isLoading:!1}))}};return(0,i.useEffect)(()=>(eY&&(eN(),eC(e=>({...e,isOpen:!1}))),()=>{if(s){let e=(0,F.createTabId)("sql",{id:eY});eo.updateTab(e,{scrollTop:eq.current})}}),[eN,eY]),(0,i.useEffect)(()=>{let t=t=>{if(ew||ev.isOpen)switch(t.key){case"Enter":("macos"===e?t.metaKey:t.ctrlKey)&&ew&&(tl(),eT());return;case"Escape":ew&&to(),eT(),ek.current?.focus();return}};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[e,ew,ev.isOpen,tl,to,eT]),(0,i.useEffect)(()=>{if(ew){let e=eI.current,t=e?.getModel();if(t&&t.original&&t.modified){t.original.setValue(e_.original),t.modified.setValue(e_.modified);let n=e.getModifiedEditor(),s=ev.startLineNumber;n.revealLineInCenter(s)}}},[eS,ef]),(0,i.useEffect)(()=>{if(e1){let e=e0.find(e=>e.identifier===s);eh.setSelectedDatabaseId(e?.identifier)}},[e1,e0,s]),(0,i.useEffect)(()=>{if(void 0!==eu.diffContent){let{diffType:e,sql:t}=eu.diffContent,n=ek.current?.getModel();n&&(0===(ek.current?.getValue()??"").length?ek.current?.executeEdits("apply-ai-message",[{text:`${t}`,range:n.getFullModelRange()}]):(ey({original:ek.current?.getValue()||"",modified:t}),eb(e)))}},[eu.diffContent]),(0,i.useEffect)(()=>{if(ew){if(eI.current&&eK)return eB(!0),()=>eB(!1)}else eO(!1),eB(!1)},[ew,eK]),(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(X,{visible:eQ,hasDestructiveOperations:eF,hasUpdateWithoutWhere:eV,onCancel:()=>{ez(!1),eG(!1),e$(!1),setTimeout(()=>ek.current?.focus(),100)},onConfirm:()=>{ez(!1),ta(!0)}}),(0,t.jsx)("div",{className:"flex h-full",children:(0,t.jsxs)(U.ResizablePanelGroup,{className:"relative",direction:"vertical",autoSaveId:h.LOCAL_STORAGE_KEYS.SQL_EDITOR_SPLIT_SIZE,children:[(0,t.jsx)(U.ResizablePanel,{defaultSize:50,maxSize:70,children:(0,t.jsx)("div",{className:"flex-grow overflow-y-auto border-b h-full",children:eZ?(0,t.jsx)("div",{className:"flex h-full w-full items-center justify-center",children:(0,t.jsx)(c.Loader2,{className:"animate-spin text-brand"})}):(0,t.jsxs)(t.Fragment,{children:[ew&&(0,t.jsxs)("div",{className:"w-full h-full",children:[(0,t.jsx)(e3,{theme:"supabase",language:"pgsql",original:e_.original,modified:e_.modified,onMount:e=>{eI.current=e,eO(!0)},options:{fontSize:13,renderSideBySide:!1,minimap:{enabled:!1},wordWrap:"on",lineNumbers:"on",folding:!1,padding:{top:4},lineNumbersMinChars:3},keepCurrentModifiedModel:!0,keepCurrentOriginalModel:!0}),eU&&(0,t.jsx)(g.default,{editor:eI.current,id:"ask-ai-diff",value:eE,onChange:eL,onSubmit:e=>{tm(e,{beforeSelection:ev.beforeSelection,selection:ev.selection||e_.modified,afterSelection:ev.afterSelection})},onAccept:tl,onReject:to,onCancel:eT,isDiffVisible:!0,isLoading:tc,startLineNumber:Math.max(0,ev.startLineNumber),endLineNumber:ev.endLineNumber})]}),(0,t.jsxs)("div",{className:"w-full h-full relative",children:[(0,t.jsx)(e4,{autoFocus:!0,placeholder:ev.isOpen||ek.current?.getValue()?"":"Hit "+("macos"===e?"CMD+K":"CTRL+K")+" to generate query or just start typing",id:eY,className:(0,V.cn)(ew&&"hidden"),editorRef:ek,monacoRef:eR,executeQuery:ta,onHasSelection:eD,onMount:e=>{let t=(0,F.createTabId)("sql",{id:eY}),n=eo.tabsMap[t];setTimeout(()=>{n?.metadata?.scrollTop&&e.setScrollTop(n.metadata.scrollTop)},20),e.onDidScrollChange(e=>eq.current=e.scrollTop)},onPrompt:({selection:e,beforeSelection:t,afterSelection:n,startLineNumber:s,endLineNumber:a})=>{eC(i=>({...i,isOpen:!0,selection:e,beforeSelection:t,afterSelection:n,startLineNumber:s,endLineNumber:a}))}}),ek.current&&ev.isOpen&&!ew&&(0,t.jsx)(g.default,{editor:ek.current,id:"ask-ai",value:eE,onChange:eL,onSubmit:e=>{tm(e,{beforeSelection:ev.beforeSelection,selection:ev.selection,afterSelection:ev.afterSelection})},onCancel:eT,isDiffVisible:!1,isLoading:tc,startLineNumber:Math.max(0,ev.startLineNumber),endLineNumber:ev.endLineNumber})]},eY)]})})}),(0,t.jsx)(U.ResizableHandle,{withHandle:!0}),(0,t.jsx)(U.ResizablePanel,{defaultSize:50,maxSize:70,children:eZ?(0,t.jsx)("div",{className:"flex h-full w-full items-center justify-center",children:(0,t.jsx)(c.Loader2,{className:"animate-spin text-brand"})}):(0,t.jsx)(e2,{id:eY,isExecuting:tt,isDisabled:ew,hasSelection:eA,prettifyQuery:ts,executeQuery:ta,onDebug:tr})}),(0,t.jsx)("div",{className:"h-9",children:eX?.rows!==void 0&&!tt&&(0,t.jsxs)(x.GridFooter,{className:"flex items-center justify-between gap-2",children:[(0,t.jsxs)(B.Tooltip,{children:[(0,t.jsx)(B.TooltipTrigger,{children:(0,t.jsxs)("p",{className:"text-xs",children:[(0,t.jsxs)("span",{className:"text-foreground",children:[eX.rows.length," row",eX.rows.length>1?"s":""]}),(0,t.jsx)("span",{className:"text-foreground-lighter ml-1",children:void 0!==eX.autoLimit&&` (Limited to only ${eX.autoLimit} rows)`})]})}),(0,t.jsx)(B.TooltipContent,{className:"max-w-xs",children:(0,t.jsxs)("p",{className:"flex flex-col gap-y-1",children:[(0,t.jsx)("span",{children:"Results are automatically limited to preserve browser performance, in particular if your query returns an exceptionally large number of rows."}),(0,t.jsx)("span",{className:"text-foreground-light",children:"You may change or remove this limit from the dropdown on the right"})]})})]}),void 0!==eX.autoLimit&&(0,t.jsxs)($.DropdownMenu,{children:[(0,t.jsx)($.DropdownMenuTrigger,{asChild:!0,children:(0,t.jsxs)(G.Button,{type:"default",iconRight:(0,t.jsx)(o.ChevronUp,{size:14}),children:["Limit results to:"," ",J.ROWS_PER_PAGE_OPTIONS.find(e=>e.value===eu.limit)?.label]})}),(0,t.jsx)($.DropdownMenuContent,{className:"w-40",align:"end",children:(0,t.jsx)($.DropdownMenuRadioGroup,{value:eu.limit.toString(),onValueChange:e=>eu.setLimit(Number(e)),children:J.ROWS_PER_PAGE_OPTIONS.map(e=>(0,t.jsx)($.DropdownMenuRadioItem,{value:e.value.toString(),children:e.label},e.label))})})]})]})})]})})]})};var e9=e.i(448710),e6=e.i(569715),e7=e.i(795826),e5=e.i(79221),te=e.i(326204),tt=e.i(853322),tn=e.i(990510);let ts=()=>{let e=(0,a.useRouter)(),{id:l,ref:o,content:c,skip:d}=(0,r.useParams)(),u=(0,n.usePrevious)(l),{data:m}=(0,R.useSelectedProjectQuery)(),h=(0,e7.useEditorType)(),p=(0,F.useTabsStateSnapshot)(),g=(0,z.useSqlEditorV2StateSnapshot)(),{history:x,setLastVisitedSnippet:f}=(0,tn.useDashboardHistory)(),y=(0,z.useSnippets)(o),S=y.find(e=>e.id===l),b=l?p.openTabs.find(e=>e.endsWith(l)):void 0,j=!!("new"!==l&&"function"==typeof g.addSnippet&&!S?.isNotSavedInDatabaseYet),{data:w,error:_,isError:N}=(0,tt.useContentIdQuery)({projectRef:o,id:l},{retry:!1,enabled:j}),v=N&&404===_.code&&_.message.includes("Content not found"),C=N&&400===_.code&&_.message.includes("Invalid uuid"),E=!!S&&v&&"new"===u&&"isNotSavedInDatabaseYet"in S;return((0,i.useEffect)(()=>{o&&w&&m&&(I.IS_PLATFORM&&w.project_id!==m.id?(f(void 0),e.push(`/project/${o}/sql/new`)):g.setSnippet(o,w))},[o,w,m]),(0,i.useEffect)(()=>{"new"===l&&"true"!==d&&void 0!==x.sql&&void 0===c&&void 0!==y.find(e=>e.id===x.sql)&&e.push(`/project/${o}/sql/${x.sql}`)},[l,y,c]),(0,i.useEffect)(()=>{if(!e.isReady||!l||"new"===l)return;let t=(0,F.createTabId)("sql",{id:l}),n=y.find(e=>e.id===l);p.addTab({id:t,type:"sql",label:n?.name||"Untitled Query",metadata:{sqlId:l,name:n?.name}})},[e.isReady,l]),(v||C)&&!E)?(0,t.jsx)("div",{className:"flex items-center justify-center h-full",children:(0,t.jsx)("div",{className:"w-[400px]",children:(0,t.jsx)(eT.Admonition,{type:"default",title:`Unable to find snippet with ID ${l}`,description:"This snippet doesn't exist in your project",children:b?(0,t.jsx)(G.Button,{type:"default",className:"mt-2",onClick:()=>{p.handleTabClose({id:b,router:e,editor:h,onClearDashboardHistory:()=>f(void 0)})},children:"Close tab"}):(0,t.jsx)(G.Button,{asChild:!0,type:"default",className:"mt-2",onClick:()=>f(void 0),children:(0,t.jsx)(s.default,{href:`/project/${o}/sql`,children:"Head back"})})})})}):(0,t.jsx)(e8,{})};ts.getLayout=e=>(0,t.jsx)(e9.default,{children:(0,t.jsx)(e6.EditorBaseLayout,{productMenu:(0,t.jsx)(te.SQLEditorMenu,{}),product:"SQL Editor",children:(0,t.jsx)(e5.default,{children:e})})}),e.s(["default",0,ts],166926)},453513,(e,t,n)=>{let s="/project/[ref]/sql/[id]";(window.__NEXT_P=window.__NEXT_P||[]).push([s,()=>e.r(166926)]),t.hot&&t.hot.dispose(function(){window.__NEXT_P.push([s])})}]);

//# debugId=72dad8fc-412d-0572-4aa0-1c1578cbd972
//# sourceMappingURL=aa2a5c0b9655f573.js.map